From f8f2ee346150136788474708bfd12a23cc3a376c Mon Sep 17 00:00:00 2001
From: Phil Eichinger <phil@zankapfel.net>
Date: Sun, 16 Aug 2015 15:52:42 +0200
Subject: [PATCH] 15khz-patches: linux-4.2.diff

---
 drivers/gpu/drm/drm_edid.c         | 101 +++++++++++++++++++++++++++++++++++++
 drivers/gpu/drm/drm_fb_helper.c    |  28 ++++++++++
 drivers/gpu/drm/drm_modes.c        |  14 +++++
 drivers/gpu/drm/drm_probe_helper.c |   6 +++
 include/drm/drm_crtc.h             |  10 ++++
 include/drm/drm_modes.h            |   2 +
 6 files changed, 161 insertions(+)

diff --git a/drivers/gpu/drm/drm_edid.c b/drivers/gpu/drm/drm_edid.c
index 7087da3..71212ee 100644
--- a/drivers/gpu/drm/drm_edid.c
+++ b/drivers/gpu/drm/drm_edid.c
@@ -142,6 +142,67 @@ static struct edid_quirk {
 };
 
 /*
+ * Arcade modelines
+ *
+ */
+static struct drm_display_mode drm_c15khz_modes[] = {
+       /* 320x240@60.00 15.660 Khz */
+       { DRM_MODE("320x240", DRM_MODE_TYPE_DRIVER, 6640, 320, 336,
+                  368, 424, 0, 240, 242, 245, 261, 0,
+                  DRM_MODE_FLAG_NHSYNC | DRM_MODE_FLAG_NVSYNC) },
+       /* 640x480@60.00 15.750 Khz */
+       { DRM_MODE("640x480", DRM_MODE_TYPE_DRIVER, 13104, 640, 664,
+                  728, 832, 0, 480, 484, 490, 525, 0,
+                  DRM_MODE_FLAG_NHSYNC | DRM_MODE_FLAG_NVSYNC | 
+                       DRM_MODE_FLAG_INTERLACE) },
+       /* 720x480@59.95 15.7369 Khz */
+       { DRM_MODE("720x480", DRM_MODE_TYPE_DRIVER, 14856, 720, 752,
+                  824, 944, 0, 480, 484, 490, 525, 0,
+                  DRM_MODE_FLAG_NHSYNC | DRM_MODE_FLAG_NVSYNC | 
+                       DRM_MODE_FLAG_INTERLACE) },
+       /* 768x576 15.6250 Khz */
+       { DRM_MODE("768x576", DRM_MODE_TYPE_DRIVER, 15625, 768, 800,
+                  872, 1000, 0, 576, 582, 588, 625, 0,
+                  DRM_MODE_FLAG_NHSYNC | DRM_MODE_FLAG_NVSYNC | 
+                       DRM_MODE_FLAG_INTERLACE) },
+       /* 800x600@50.00 15.725 Khz */
+       { DRM_MODE("800x576", DRM_MODE_TYPE_DRIVER, 16354, 800, 832,
+                  912, 1040, 0, 576, 584, 590, 629, 0,
+                  DRM_MODE_FLAG_NHSYNC | DRM_MODE_FLAG_NVSYNC | 
+                       DRM_MODE_FLAG_INTERLACE) },
+       /* 1024@768@40.00 16.300 Khz */
+       { DRM_MODE("1024x768", DRM_MODE_TYPE_DRIVER, 21386, 1024, 1072,
+                  1168, 1312, 0, 768, 774, 780, 815, 0,
+                  DRM_MODE_FLAG_NHSYNC | DRM_MODE_FLAG_NVSYNC | 
+                       DRM_MODE_FLAG_INTERLACE) },
+};
+static const int drm_num_c15khz_modes =
+       sizeof(drm_c15khz_modes) / sizeof(struct drm_display_mode);
+
+static struct drm_display_mode drm_c25khz_modes[] = {
+       /* 320x240@60.00 24.960 Khz */
+       { DRM_MODE("320x240", DRM_MODE_TYPE_DRIVER, 10782, 320, 352,
+                  384, 432, 0, 240, 318, 322, 416, 0,
+                  DRM_MODE_FLAG_NHSYNC | DRM_MODE_FLAG_NVSYNC) },
+       /* 512x384@58.59 24.960 Khz */
+       { DRM_MODE("512x384", DRM_MODE_TYPE_DRIVER, 16972, 512, 560,
+                  608, 680, 0, 384, 395, 399, 426, 0,
+                  DRM_MODE_FLAG_NHSYNC | DRM_MODE_FLAG_NVSYNC) },
+       /* 800x600@60.00 24.990 Khz */
+       { DRM_MODE("800x600", DRM_MODE_TYPE_DRIVER, 26989, 800, 880,
+                  960, 1080, 0, 600, 697, 705, 833, 0,
+                  DRM_MODE_FLAG_NHSYNC | DRM_MODE_FLAG_NVSYNC | 
+                       DRM_MODE_FLAG_INTERLACE) },
+       /* 1024x768@50.00 24.975 Khz */
+       { DRM_MODE("1024x768", DRM_MODE_TYPE_DRIVER, 34165, 1024, 1120,
+                  1216, 1368, 0, 768, 864, 872, 999, 0,
+                  DRM_MODE_FLAG_NHSYNC | DRM_MODE_FLAG_NVSYNC | 
+                       DRM_MODE_FLAG_INTERLACE) },
+};
+static const int drm_num_c25khz_modes =
+       sizeof(drm_c25khz_modes) / sizeof(struct drm_display_mode);
+
+/*
  * Autogenerated from the DMT spec.
  * This table is copied from xfree86/modes/xf86EdidModes.c.
  */
@@ -1506,6 +1567,46 @@ mode_is_rb(const struct drm_display_mode *mode)
 	       (mode->vsync_start - mode->vdisplay == 3);
 }
 
+struct drm_display_mode *drm_mode_find_c15khz(struct drm_device *dev,
+                                          int hsize, int vsize, int fresh)
+{
+       int i;
+
+       for (i = 0; i < drm_num_c15khz_modes; i++) {
+               const struct drm_display_mode *ptr = &drm_c15khz_modes[i];
+               if (hsize != ptr->hdisplay)
+                       continue;
+               if (vsize != ptr->vdisplay)
+                       continue;
+               if ((fresh != 0) && (fresh != drm_mode_vrefresh(ptr)))
+                       continue;
+
+               return drm_mode_duplicate(dev, ptr);
+       }
+       return NULL;
+}
+EXPORT_SYMBOL(drm_mode_find_c15khz);
+
+struct drm_display_mode *drm_mode_find_c25khz(struct drm_device *dev,
+                                          int hsize, int vsize, int fresh)
+{
+       int i;
+
+       for (i = 0; i < drm_num_c25khz_modes; i++) {
+               const struct drm_display_mode *ptr = &drm_c25khz_modes[i];
+               if (hsize != ptr->hdisplay)
+                       continue;
+               if (vsize != ptr->vdisplay)
+                       continue;
+               if ((fresh != 0) && (fresh != drm_mode_vrefresh(ptr)))
+                       continue;
+
+               return drm_mode_duplicate(dev, ptr);
+       }
+       return NULL;
+}
+EXPORT_SYMBOL(drm_mode_find_c25khz);
+
 /*
  * drm_mode_find_dmt - Create a copy of a mode if present in DMT
  * @dev: Device to duplicate against
diff --git a/drivers/gpu/drm/drm_fb_helper.c b/drivers/gpu/drm/drm_fb_helper.c
index cac4229..f6891b5 100644
--- a/drivers/gpu/drm/drm_fb_helper.c
+++ b/drivers/gpu/drm/drm_fb_helper.c
@@ -1296,6 +1296,34 @@ struct drm_display_mode *drm_pick_cmdline_mode(struct drm_fb_helper_connector *f
 	if (cmdline_mode->rb || cmdline_mode->margins)
 		goto create_mode;
 
+	if (cmdline_mode->c15khz) {
+		mode = drm_mode_find_c15khz(fb_helper_conn->connector->dev,
+			cmdline_mode->xres,
+			cmdline_mode->yres,
+			(cmdline_mode->refresh_specified) ?
+				cmdline_mode->refresh : 0);
+
+		if (mode) {
+			drm_mode_set_crtcinfo(mode, CRTC_INTERLACE_HALVE_V);
+			list_add(&mode->head, &fb_helper_conn->connector->modes);
+			return mode;
+		}
+	}
+
+	if (cmdline_mode->c25khz) {
+		mode = drm_mode_find_c25khz(fb_helper_conn->connector->dev,
+			cmdline_mode->xres,
+			cmdline_mode->yres,
+			(cmdline_mode->refresh_specified) ?
+				cmdline_mode->refresh : 0);
+
+		if (mode) {
+			drm_mode_set_crtcinfo(mode, CRTC_INTERLACE_HALVE_V);
+			list_add(&mode->head, &fb_helper_conn->connector->modes);
+			return mode;
+		}
+	}
+
 	prefer_non_interlace = !cmdline_mode->interlace;
 again:
 	list_for_each_entry(mode, &fb_helper_conn->connector->modes, head) {
diff --git a/drivers/gpu/drm/drm_modes.c b/drivers/gpu/drm/drm_modes.c
index cd74a09..5f4e8cc 100644
--- a/drivers/gpu/drm/drm_modes.c
+++ b/drivers/gpu/drm/drm_modes.c
@@ -1232,6 +1232,8 @@ bool drm_mode_parse_command_line_for_connector(const char *mode_option,
 	bool interlace = false, margins = false, was_digit = false;
 	int i;
 	enum drm_connector_force force = DRM_FORCE_UNSPECIFIED;
+	int c15khz = 0;
+	int c25khz = 0;
 
 #ifdef CONFIG_FB
 	if (!mode_option)
@@ -1321,6 +1323,14 @@ bool drm_mode_parse_command_line_for_connector(const char *mode_option,
 
 			force = DRM_FORCE_OFF;
 			break;
+		case 'c':
+			c15khz = 1;
+			c25khz = 0;
+			break;
+		case 'z':
+			c15khz = 0;
+			c25khz = 1;
+			break;
 		default:
 			goto done;
 		}
@@ -1366,6 +1376,10 @@ bool drm_mode_parse_command_line_for_connector(const char *mode_option,
 	mode->interlace = interlace;
 	mode->margins = margins;
 	mode->force = force;
+	mode->c15khz = c15khz ? true : false;
+	connector->c15khz = mode->c15khz;
+	mode->c25khz = c25khz ? true : false;
+	connector->c25khz = mode->c25khz;
 
 	return true;
 }
diff --git a/drivers/gpu/drm/drm_probe_helper.c b/drivers/gpu/drm/drm_probe_helper.c
index 04203c0..f27722c 100644
--- a/drivers/gpu/drm/drm_probe_helper.c
+++ b/drivers/gpu/drm/drm_probe_helper.c
@@ -165,6 +165,12 @@ static int drm_helper_probe_single_connector_modes_merge_bits(struct drm_connect
 		goto prune;
 	}
 
+	if (connector->c15khz)
+		goto prune;
+
+	if (connector->c25khz)
+		goto prune;
+
 #ifdef CONFIG_DRM_LOAD_EDID_FIRMWARE
 	count = drm_load_edid_firmware(connector);
 	if (count == 0)
diff --git a/include/drm/drm_crtc.h b/include/drm/drm_crtc.h
index 3b4d8a4..882ffb8 100644
--- a/include/drm/drm_crtc.h
+++ b/include/drm/drm_crtc.h
@@ -743,6 +743,12 @@ struct drm_connector {
 	uint8_t num_h_tile, num_v_tile;
 	uint8_t tile_h_loc, tile_v_loc;
 	uint16_t tile_h_size, tile_v_size;
+
+	/* 15KHz output */
+	bool c15khz;
+
+	/* 25KHz output */
+	bool c25khz;
 };
 
 /**
@@ -1495,6 +1501,10 @@ extern int drm_edid_header_is_valid(const u8 *raw_edid);
 extern bool drm_edid_block_valid(u8 *raw_edid, int block, bool print_bad_edid,
 				 bool *edid_corrupt);
 extern bool drm_edid_is_valid(struct edid *edid);
+struct drm_display_mode *drm_mode_find_c15khz(struct drm_device *dev,
+					      int hsize, int vsize, int fresh);
+struct drm_display_mode *drm_mode_find_c25khz(struct drm_device *dev,
+					      int hsize, int vsize, int fresh);
 
 extern struct drm_tile_group *drm_mode_create_tile_group(struct drm_device *dev,
 							 char topology[8]);
diff --git a/include/drm/drm_modes.h b/include/drm/drm_modes.h
index 08a8cac..6373b91 100644
--- a/include/drm/drm_modes.h
+++ b/include/drm/drm_modes.h
@@ -162,6 +162,8 @@ struct drm_cmdline_mode {
 	bool cvt;
 	bool margins;
 	enum drm_connector_force force;
+	bool c15khz;
+	bool c25khz;
 };
 
 /**
